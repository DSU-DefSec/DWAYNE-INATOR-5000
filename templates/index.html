{{ template "head.html" . }}

{{ $m := .m }}
{{ $team := .user }}
{{ $records := .statusRecords }}

{{ template "refresh.html" }}

{{ if .user.IsAdmin }}
{{ if .configErrors }}
	<br>
    <p style="background-color: var(--red); padding: 1rem; text-align: center">
	    {{ range $err := .configErrors }}
	    {{ . }}<br>
	    {{ end }}
    </p>
{{ end }}
{{ end }}

{{ if $records }}
<br>
<h2>Status</h2>

{{ if not .m.Running }}
<p style="text-align: center">
üßä Scoring paused at {{ (.pauseTime.In .loc).Format "03:04:05 PM" }}.
</p>
<br>
{{ end }}

<table class="checks">
    <tr>
        <th style="border-bottom: none"></th>
        {{ range $box := .m.Box }}
        <th colspan="{{ len .CheckList }}"> {{ .Name }}</th>
        {{ end }}
    </tr>
    <tr>
    <th></th>
    {{ template "boxlist.html" $m }}
    </tr>
    {{ range $index, $record := $records }}
    <tr>
        <td class="teamname">
            {{ if $team }}
                {{ if $m.IsValid $team .Team.Name }}
                <a href="/team/{{ .Team.ID }}">
                {{ end }}
            {{ end }}
            {{ .Team.Name }}
            {{ if $team }}
                {{ if $m.IsValid $team .Team.Name }}
                    </a>
                {{ end }}
            {{ end }}
        </td>

        {{ range $box := $m.Box }}
        {{ range .CheckList }}

        {{ $check := index $record.ResultsMap .Name }}

            <!-- Persist calculations -->
            {{ $isPersisted := false }}
            {{ if $record.Persists }}
                {{ range $i := $record.Persists }}
                    {{ if eq $check.Box .Box }}
                        {{ $isPersisted = true }}
                    {{ end }}
                {{ end }}
                {{ if $isPersisted }}
                    {{ template "persist.html" $record.Persists }}
                {{ else }}
                <td>
                {{ end }}
            {{ else }}
                <td>
            {{ end }}

            {{ if ne $check.Name "" }}

                {{ if $team }}
                    {{ if $m.IsValid $team $record.Team.Name }}
                    <a href="/team/{{ $record.Team.ID }}/{{ $check.Name }}">
                    {{ end }}
                {{ end }}
                {{ template "bool.html" $check.Status }}

            {{ else }}
            	<a>
                <img src="/assets/pending.png"/>
            {{ end }}

            {{ if $team }}
                {{ if $m.IsValid $team $record.Team.Name }}
                </a>
                {{ end }}
            {{ end }}

          {{ else }}
        </td>
        {{ end }}
        {{ end }}
    </tr>
    {{ end }}
</table>
<br>
<p style="text-align: center">
‚è±Ô∏è Round {{ .round }}. Checks last ran at <b>{{ ((index .statusRecords 0).Time.In .loc).Format "03:04:05 PM" }}</b>.{{ if $m.Running }} Event has been running for <b>{{ .runtime }}</b>.{{ end }}
</p>


<br>
<h2>Uptime</h2>

<table class="uptime">
    <tr>
        <th style="border: none"></th>
        {{ range $box := .m.Box }}
        <th colspan="{{ len .CheckList }}"><i>{{ .Name }}</i></th>
        {{ end }}
    </tr>
    <th></th>
    {{ template "boxlist.html" .m }}

    {{ range $index, $record := $records }}
    <tr>
        <td class="teamname">
            {{ if $team }}
                {{ if $m.IsValid $team .Team.Name }}
                <a href="/team/{{ .Team.ID }}">
                {{ end }}
            {{ end }}
            {{ .Team.Name }}
            {{ if $team }}
                {{ if $m.IsValid $team .Team.Name }}
                    </a>
                {{ end }}
            {{ end }}
        </td>
        {{ range $box := $m.Box }}
        {{ range .CheckList }}

        {{ $check := index $record.ResultsMap .Name }}
            {{ if eq $check.Name "" }}
            <td style="background-color: var(--grayt);">
            {{ else }}
            <td style="{{ if gt $check.Uptime 89 }}
            background-color: var(--greent);
            {{ else if gt $check.Uptime 59 }}
            background-color: var(--yellowt);
            {{ else if gt $check.Uptime 39 }}
            background-color: var(--oranget);
            {{ else }}
            background-color: var(--redt);
            {{ end }}"
            >
            {{ end }}
            {{ if $team }}
                {{ if $m.IsValid $team $record.Team.Name }}
                <a style="text-decoration: none; color: var(--black);" href="/team/{{ $record.Team.ID }}/{{ $check.Name }}">
                {{ end }}
            {{ end }}
            {{ if eq $check.Name "" }}
            N/A
            {{ else }}
            {{ $check.Uptime }}%
            {{ end }}
            {{ if $team }}
                {{ if $m.IsValid $team $record.Team.Name }}
                </a>
                {{ end }}
            {{ end }}
            </td>
        {{ end }}
        {{ end }}
    </tr>
    {{ end }}
</table>

<br>
<br>
<h2>Scores Over Time</h2>

<br>
<img class="graph graph-light" src="assets/points.png"/>
<img class="graph graph-dark" src="assets/points-dark.png"/>


<br>
<p style="text-align: center">
    üìà Scores calculated at <b>{{ ((index .records 0).Time.In .loc).Format "03:04:05 PM" }}</b>.
</p>


<br>
<h2>Standings</h2>
<br>
<table>
    <th>Rank</th>
    <th>Team</th>
    <th>Service</th>
    <th>SLA</th>
    <th>Injects</th>
    {{ if $m.Red }}
    <!--<th>Red Team</th>-->
    {{ end }}
    {{ if $m.Persists }}
    <th>Lost Points (Stolen From You)</th>
    <th>Gained Points (You've Stolen)</th>
    <th>Bonus Hack Points</th>
    {{ end }}
    {{ if not $m.NoPasswords }}
    <th>Reset Penalties</th>
    {{ end }}
    <th>Total</th>

    {{ range $index, $record := .records }}
    <tr>
        <td>{{ $index | increment }}</td>
        {{ if eq $record.TeamID $team.ID }}
            <td class="teamname">
                <a style="text-align: center" href="/team/{{ $team.ID }}">
                    {{ $record.Team.Name }}
                </a>
            </td>
        {{ else }}
            <td>{{ $record.Team.Name }}</td>
        {{ end }}
        <td>{{ mul $record.ServicePoints $m.ServicePoints }}</td>
        <td>{{ $record.SlaViolations }}</td>
        {{ if eq $record.TeamID $team.ID }}
            <td>
                <a style="text-align: center" href="/injects">
                    {{ $record.InjectPoints }}
                </a>
            </td>
        {{ else }}
            <td>{{ $record.InjectPoints }}</td>
        {{ end }}
        {{ if $m.Red }}
        <!--<td>{{ $record.RedTeamPoints }}</td>-->
        {{ end }}
        {{ if $m.Persists }}
        <td>{{ $record.PointsLost }}</td>
        <td>{{ $record.PointsStolen }}</td>
        <td>{{ $record.PersistPoints }}</td>
        {{ end  }}
        {{ if not $m.NoPasswords }}
        <td>{{ $record.ManualAdjustment }}</td>
        {{ end }}
        <td><b>{{ $record.Total }}</b></td>
    </tr>
    {{ end }}
</table>
<br>

{{ else }}

{{ if .m.Running }}
<br>
<p style="text-align: center">
First round of checks are currently running. Good luck! üçÄ
</p>
{{ else }}
<br>
<p style="text-align: center">
‚è≥ Competition organizers haven't started scoring yet.
</p>
{{ end }}

{{ end }}

{{ if .ip }}
    {{ if not (or (eq .ip "::1") (eq .ip "127.0.0.1")) }}
    <p style="text-align: center; font-size: 0.8em">
    üëã Hello {{ .ip }}!
    </p>
    {{ end }}
{{ end }}

{{ template "feet.html" }}
